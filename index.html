
<html>
  <head>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  </head>
  <body>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

    <h1>Sylvac S_Cal EVO caliper IP67</h1>
    <h2><p id="display"></p></h2>

<button onclick="connectBTNew()">Connect BT</button>
<button onclick="addNewRow();">Add row</button>
<p>
 

  <table class="table table-striped table-bordered table-hover table-condensed" id="table">
    <tr id="datarow"><td>1</td></td></tr>
  </table>

  <hr>
  <pre id="log">Ver: 7g</pre>

</p>

<script>
  window.line = 1;
  window.maxcol = 1;
  window.curcol = 1;
  document.getElementById("display").innerHTML = " 000.00";
</script> 
    
    <script>
          //log = console.log;
          function log(a) {
            document.getElementById("log").innerHTML += "\n"+a;
          }
          async function onBatteryButtonClick() {
            try {
              log('Requesting Bluetooth Device...');
              const device = await navigator.bluetooth.requestDevice({
                  filters: [{services: ['battery_service']}] });

              log('Connecting to GATT Server...');
              const server = await device.gatt.connect();

              log('Getting Battery Service...');
              const service = await server.getPrimaryService('battery_service');

              log('Getting Battery Level Characteristic...');
              const characteristic = await service.getCharacteristic('battery_level');

              log('Reading Battery Level...');
              const value = await characteristic.readValue();

              log('> Battery Level is ' + value.getUint8(0) + '%');
            } catch(error) {
              log('Argh! ' + error);
            }
          }

          async function connectBTNew() {
            try {
              log("Requesting caliper device");
              //const device = await navigator.bluetooth.requestDevice({filters: [{ services: ['c1b25000-caaf-6d0e-4c33-7dae30052840'] }] });
              const device = await navigator.bluetooth.requestDevice( {acceptAllDevices: true,  optionalServices: ['c1b25000-caaf-6d0e-4c33-7dae30052840']} );
              log("Got device " + device.name);
              
              log('Connecting to GATT Server...');
              const server = await device.gatt.connect();

              log('Getting caliper Service...');
              const service = await server.getPrimaryService('c1b25000-caaf-6d0e-4c33-7dae30052840');
              log("Got service");

              const notif_characteristics = await service.getCharacteristic("c1b25013-caaf-6d0e-4c33-7dae30052840");
              log("Notification chararacteristics " + JSON.stringify( notif_characteristics ) );

              await notif_characteristics.startNotifications();
              log("Notifications started")
              notif_characteristics.addEventListener('characteristicvaluechanged', handleNotif);

              const indic_characteristics = await service.getCharacteristic("c1b25010-caaf-6d0e-4c33-7dae30052840");
              log("Indication characteristics"+  JSON.stringify(indic_characteristics)); 

              await indic_characteristics.startNotifications();
              log("Indication characteristics notifications started")
              indic_characteristics.addEventListener('characteristicvaluechanged', handleInd);

              const characteristic = await service.getCharacteristic("c1b25012-caaf-6d0e-4c33-7dae30052840");
              var enc = new TextEncoder("utf-8");
              //characteristic.writeValue(enc.encode("?\r"));
              window.btch = characteristic;

              setInterval(function(){ 
                //console.log("tick"); 
                characteristic.writeValue(enc.encode("?\r")); 
              }, 300);

            } catch(error) {
              log('Error: ' + error);
            }
          }
      
    
      function handleNotif(event) {
        let value = event.target.value;
        var decoder = new TextDecoder("utf-8");
        var decodedString = decoder.decode(value);
        //console.log("Read value: " + decodedString);
        document.getElementById("display").innerHTML = decodedString;
      }

      function addMissingColumns()
      {
        Array.from(document.getElementById("table").getElementsByTagName("TR")).forEach(
            function (tr) { 
              //console.log(tr, window.maxcol-Array.from(tr.cells).length); 
              

              cellCount = Array.from(tr.cells).length;
              console.log(window.maxcol, window.curcol, Array.from(tr.cells).length);
              for(i=0;i<(window.maxcol-cellCount);i++ ) {
                tr.innerHTML += "<td></td>"
              } 
            }
        );
      }

      function addNewData(datastr) {
        if (window.curcol > 7) addNewRow();

        document.getElementById("datarow").innerHTML += "<td>"+datastr+"</td>";
        window.curcol += 1;
        if (window.curcol>window.maxcol) {
          console.log("review column count. new maxcol ", window.curcol);
          window.maxcol = window.curcol;
          addMissingColumns();
        }
    
      }

      function handleInd(event) {
        let value = event.target.value;
        var decoder = new TextDecoder("utf-8");
        var decodedString = decoder.decode(value);
        //log("Button pressed for " + decodedString);
        
        //log("deciding on "+ JSON.stringify(parseInt(decodedString.substring(1) )) );
        //log("deciding on "+ JSON.stringify(parseInt(decodedString.substring(1) )>=70) );
        
        // add new line above 70 mm
        if (parseInt(decodedString.substring(1) )>=70) {
          addNewRow(); 
          return;
        }

        addNewData(decodedString);
      }  

      function addNewRow() {
        addMissingColumns(); 

        window.line += 1;
        window.curcol = 1;
        document.getElementById('datarow')
          .insertAdjacentHTML('afterend', '<tr id="newrow"><td>' + window.line.toString() + '</td></row>');
        datarow = document.getElementById("datarow");
        newrow = document.getElementById("newrow");
        datarow.removeAttribute('id');
        newrow.setAttribute("id", "datarow");
        newrow.scrollIntoView();
      }

    </script>
  </body>
 </html>
